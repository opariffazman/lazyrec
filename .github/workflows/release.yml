name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      # Pin to FFmpeg 7.1 â€” ffmpeg-sys-next 7.1.3 is incompatible with FFmpeg 8.x
      FFMPEG_DOWNLOAD_URL: https://github.com/GyanD/codexffmpeg/releases/download/7.1/ffmpeg-7.1-full_build-shared.7z

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"
          cache-on-failure: true
          shared-key: "windows-release"
          cache-all-crates: true

      - name: Install FFmpeg (pre-built shared)
        run: |
          $VCINSTALLDIR = $(& "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath)
          echo "LIBCLANG_PATH=${VCINSTALLDIR}\VC\Tools\LLVM\x64\bin" >> $env:GITHUB_ENV
          Invoke-WebRequest "${env:FFMPEG_DOWNLOAD_URL}" -OutFile ffmpeg-release-full-shared.7z
          7z x ffmpeg-release-full-shared.7z
          mkdir ffmpeg
          mv ffmpeg-*/* ffmpeg/
          echo "FFMPEG_DIR=${pwd}\ffmpeg" >> $env:GITHUB_ENV
          echo "${pwd}\ffmpeg\bin" >> $env:GITHUB_PATH

      - name: Patch FFmpeg headers for ffmpeg-sys-next
        run: |
          # FFmpeg 7+ removed avfft.h but ffmpeg-sys-next build.rs still
          # includes it unconditionally. When missing, search_include() falls
          # back to /usr/include/ (Unix path) which fails on Windows.
          # Create stub headers so bindgen finds them at the correct path.
          $headers = @(
            "libavcodec/avfft.h",
            "libavcodec/vorbis_parser.h"
          )
          foreach ($h in $headers) {
            $path = "$env:FFMPEG_DIR\include\$h"
            if (-not (Test-Path $path)) {
              echo "Creating stub: $path"
              New-Item -ItemType File -Path $path -Force | Out-Null
            }
          }
          # Remove .pc files with hardcoded Unix paths
          Remove-Item -Recurse -Force "$env:FFMPEG_DIR\lib\pkgconfig" -ErrorAction SilentlyContinue
          echo "FFMPEG_DIR=$env:FFMPEG_DIR"
          ffmpeg -version

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri (compile only)
        run: cargo build --release --manifest-path src-tauri/Cargo.toml

      - name: Copy FFmpeg DLLs alongside exe
        run: |
          # Copy FFmpeg DLLs directly next to the compiled binary.
          # This ensures they end up in $INSTDIR (alongside LazyRec.exe)
          # when Tauri creates the NSIS/MSI installer.
          $target = "src-tauri\target\release"
          $dlls = @(
            "avcodec-61.dll",
            "avdevice-61.dll",
            "avfilter-10.dll",
            "avformat-61.dll",
            "avutil-59.dll",
            "swresample-5.dll",
            "swscale-8.dll",
            "postproc-58.dll"
          )
          foreach ($dll in $dlls) {
            $src = "$env:FFMPEG_DIR\bin\$dll"
            if (Test-Path $src) {
              Copy-Item $src "$target\"
              echo "Copied $dll to $target"
            } else {
              echo "WARNING: $dll not found in FFmpeg"
            }
          }
          echo ""
          echo "DLLs alongside exe:"
          Get-ChildItem "$target\*.dll" | ForEach-Object { echo "  $($_.Name)" }

      - name: Bundle Tauri installers
        run: cargo tauri build --bundles nsis,msi
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $bundleDir = "src-tauri\target\release\bundle"

          # Create GitHub release
          gh release create $tag --title "LazyRec $tag" --notes "See the commits for changes in this release." --latest

          # Upload NSIS installer + signature
          $nsisDir = "$bundleDir\nsis"
          Get-ChildItem "$nsisDir\*" -Include "*.exe","*.exe.sig","*.nsis.zip","*.nsis.zip.sig" | ForEach-Object {
            echo "Uploading: $($_.Name)"
            gh release upload $tag $_.FullName --clobber
          }

          # Upload MSI installer + signature
          $msiDir = "$bundleDir\msi"
          Get-ChildItem "$msiDir\*" -Include "*.msi","*.msi.sig","*.msi.zip","*.msi.zip.sig" | ForEach-Object {
            echo "Uploading: $($_.Name)"
            gh release upload $tag $_.FullName --clobber
          }

          # Upload updater latest.json if it exists
          $latestJson = "$bundleDir\nsis\latest.json"
          if (-not (Test-Path $latestJson)) {
            $latestJson = "$nsisDir\..\latest.json"
          }
          # Search more broadly for latest.json
          $found = Get-ChildItem "$bundleDir" -Recurse -Filter "latest.json" | Select-Object -First 1
          if ($found) {
            echo "Uploading: latest.json from $($found.FullName)"
            gh release upload $tag $found.FullName --clobber
          } else {
            echo "WARNING: latest.json not found in bundle output"
          }
