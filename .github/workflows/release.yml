name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      # Pin to FFmpeg 7.1 â€” ffmpeg-sys-next 7.1.3 is incompatible with FFmpeg 8.x
      FFMPEG_DOWNLOAD_URL: https://github.com/GyanD/codexffmpeg/releases/download/7.1/ffmpeg-7.1-full_build-shared.7z

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"
          cache-on-failure: true
          shared-key: "windows-release"
          cache-all-crates: true

      - name: Install FFmpeg (pre-built shared)
        run: |
          $VCINSTALLDIR = $(& "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath)
          echo "LIBCLANG_PATH=${VCINSTALLDIR}\VC\Tools\LLVM\x64\bin" >> $env:GITHUB_ENV
          Invoke-WebRequest "${env:FFMPEG_DOWNLOAD_URL}" -OutFile ffmpeg-release-full-shared.7z
          7z x ffmpeg-release-full-shared.7z
          mkdir ffmpeg
          mv ffmpeg-*/* ffmpeg/
          echo "FFMPEG_DIR=${pwd}\ffmpeg" >> $env:GITHUB_ENV
          echo "${pwd}\ffmpeg\bin" >> $env:GITHUB_PATH

      - name: Patch FFmpeg headers for ffmpeg-sys-next
        run: |
          # FFmpeg 7+ removed avfft.h but ffmpeg-sys-next build.rs still
          # includes it unconditionally. When missing, search_include() falls
          # back to /usr/include/ (Unix path) which fails on Windows.
          # Create stub headers so bindgen finds them at the correct path.
          $headers = @(
            "libavcodec/avfft.h",
            "libavcodec/vorbis_parser.h"
          )
          foreach ($h in $headers) {
            $path = "$env:FFMPEG_DIR\include\$h"
            if (-not (Test-Path $path)) {
              echo "Creating stub: $path"
              New-Item -ItemType File -Path $path -Force | Out-Null
            }
          }
          # Remove .pc files with hardcoded Unix paths
          Remove-Item -Recurse -Force "$env:FFMPEG_DIR\lib\pkgconfig" -ErrorAction SilentlyContinue
          echo "FFMPEG_DIR=$env:FFMPEG_DIR"
          ffmpeg -version

      - name: Bundle FFmpeg DLLs for installer
        run: |
          # Copy FFmpeg shared DLLs to src-tauri so Tauri bundles them
          $dlls = @(
            "avcodec-61.dll",
            "avdevice-61.dll",
            "avfilter-10.dll",
            "avformat-61.dll",
            "avutil-59.dll",
            "swresample-5.dll",
            "swscale-8.dll",
            "postproc-58.dll"
          )
          foreach ($dll in $dlls) {
            $src = "$env:FFMPEG_DIR\bin\$dll"
            if (Test-Path $src) {
              Copy-Item $src "src-tauri\"
              echo "Bundled: $dll"
            } else {
              echo "Warning: $dll not found"
            }
          }

      - name: Install frontend dependencies
        run: npm ci

      - name: Verify FFmpeg DLLs in src-tauri
        run: |
          echo "DLLs in src-tauri/:"
          Get-ChildItem src-tauri\*.dll | ForEach-Object { echo "  $($_.Name) ($($_.Length) bytes)" }
          $count = (Get-ChildItem src-tauri\*.dll).Count
          if ($count -eq 0) { throw "No DLLs found in src-tauri/" }
          echo "Total: $count DLLs ready for bundling"

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # Bundle FFmpeg DLLs as resources (DLLs copied to src-tauri/ in earlier step)
          TAURI_CONFIG: '{"bundle":{"resources":["*.dll"]}}'
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "LazyRec ${{ github.ref_name }}"
          releaseBody: "See the commits for changes in this release."
          releaseDraft: false
          prerelease: false
