name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      # Pin to FFmpeg 7.1 â€” ffmpeg-sys-next 7.1.3 is incompatible with FFmpeg 8.x
      FFMPEG_DOWNLOAD_URL: https://github.com/GyanD/codexffmpeg/releases/download/7.1/ffmpeg-7.1-full_build-shared.7z

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"
          cache-on-failure: true

      - name: Install FFmpeg (pre-built shared)
        run: |
          $VCINSTALLDIR = $(& "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath)
          echo "LIBCLANG_PATH=${VCINSTALLDIR}\VC\Tools\LLVM\x64\bin" >> $env:GITHUB_ENV
          Invoke-WebRequest "${env:FFMPEG_DOWNLOAD_URL}" -OutFile ffmpeg-release-full-shared.7z
          7z x ffmpeg-release-full-shared.7z
          mkdir ffmpeg
          mv ffmpeg-*/* ffmpeg/
          echo "FFMPEG_DIR=${pwd}\ffmpeg" >> $env:GITHUB_ENV
          echo "${pwd}\ffmpeg\bin" >> $env:GITHUB_PATH

      - name: Patch FFmpeg headers for ffmpeg-sys-next
        run: |
          # FFmpeg 7+ removed avfft.h but ffmpeg-sys-next build.rs still
          # includes it unconditionally. When missing, search_include() falls
          # back to /usr/include/ (Unix path) which fails on Windows.
          # Create stub headers so bindgen finds them at the correct path.
          $headers = @(
            "libavcodec/avfft.h",
            "libavcodec/vorbis_parser.h"
          )
          foreach ($h in $headers) {
            $path = "$env:FFMPEG_DIR\include\$h"
            if (-not (Test-Path $path)) {
              echo "Creating stub: $path"
              New-Item -ItemType File -Path $path -Force | Out-Null
            }
          }
          # Remove .pc files with hardcoded Unix paths
          Remove-Item -Recurse -Force "$env:FFMPEG_DIR\lib\pkgconfig" -ErrorAction SilentlyContinue
          echo "FFMPEG_DIR=$env:FFMPEG_DIR"
          ffmpeg -version

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "LazyRec ${{ github.ref_name }}"
          releaseBody: "See the commits for changes in this release."
          releaseDraft: false
          prerelease: false
