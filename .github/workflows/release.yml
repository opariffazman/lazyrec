name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      FFMPEG_DOWNLOAD_URL: https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"
          cache-on-failure: true

      - name: Install FFmpeg (pre-built shared)
        run: |
          $VCINSTALLDIR = $(& "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath)
          echo "LIBCLANG_PATH=${VCINSTALLDIR}\VC\Tools\LLVM\x64\bin" >> $env:GITHUB_ENV
          Invoke-WebRequest "${env:FFMPEG_DOWNLOAD_URL}" -OutFile ffmpeg-release-full-shared.7z
          7z x ffmpeg-release-full-shared.7z
          mkdir ffmpeg
          mv ffmpeg-*/* ffmpeg/
          echo "FFMPEG_DIR=${pwd}\ffmpeg" >> $env:GITHUB_ENV
          echo "FFMPEG_INCLUDE_DIR=${pwd}\ffmpeg\include" >> $env:GITHUB_ENV
          echo "${pwd}\ffmpeg\bin" >> $env:GITHUB_PATH

      - name: Verify FFmpeg setup
        run: |
          echo "FFMPEG_DIR=$env:FFMPEG_DIR"
          echo "FFMPEG_INCLUDE_DIR=$env:FFMPEG_INCLUDE_DIR"
          # Remove .pc files with hardcoded Unix paths that confuse bindgen
          Remove-Item -Recurse -Force "$env:FFMPEG_DIR\lib\pkgconfig" -ErrorAction SilentlyContinue
          ls $env:FFMPEG_DIR\include\libavcodec\ | Select-Object -First 5
          ffmpeg -version

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "LazyRec ${{ github.ref_name }}"
          releaseBody: "See the commits for changes in this release."
          releaseDraft: false
          prerelease: false
